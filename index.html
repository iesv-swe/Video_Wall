<!DOCTYPE html>
<html>
<head>
    <title>School Digital Signage</title>
    <!-- CSS IS NOW INSIDE THE HTML -->
    <style>
        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; background-color: black; }
        .content-container { display: none; width: 100%; height: 100%; box-sizing: border-box; }
        #text-wrapper, #error-wrapper, #setup-wrapper {
            color: white; font-family: sans-serif; padding: 40px; display: flex; 
            flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        #error-wrapper { color: #ff6b6b; }
        #text-headline { font-size: 4em; margin-bottom: 20px; }
        #text-body { font-size: 2em; }
        #video-wrapper { padding: 0; }
        #kiosk-video { width: 100%; height: 100%; object-fit: cover; }
        #slide-wrapper iframe { width: 100%; height: 100%; border: 0; }
        #stretch-wrapper { position: relative; overflow: hidden; }
        .stretched-element { position: absolute; width: 200%; height: 200%; border: 0; transform-origin: 0 0; }
        .flip-180 { transform: rotate(180deg); }
    </style>
</head>
<body>
    <div id="stretch-wrapper" class="content-container"></div>
    <div id="slide-wrapper" class="content-container"></div>
    <div id="text-wrapper" class="content-container">
        <h1 id="text-headline"></h1>
        <p id="text-body"></p>
    </div>
    <div id="video-wrapper" class="content-container">
        <video id="kiosk-video" src="" autoplay muted loop></video>
    </div>
    <div id="error-wrapper" class="content-container">
        <h1 id="error-headline">Error</h1>
        <p id="error-body"></p>
    </div>
    <div id="setup-wrapper" class="content-container"></div>

    <!-- JS IS NOW INSIDE THE HTML -->
    <script>
        window.onload = function() {
            const allWrappers = {
                stretch: document.getElementById('stretch-wrapper'), slide: document.getElementById('slide-wrapper'),
                text: document.getElementById('text-wrapper'), video: document.getElementById('video-wrapper'),
                error: document.getElementById('error-wrapper'), setup: document.getElementById('setup-wrapper')
            };
            const params = new URLSearchParams(window.location.search);
            let deviceId = params.get('device');

            if (deviceId) { loadContent(deviceId); } 
            else { showSetupScreen(); }

            function loadContent(id) {
                if (id === '1' || id === '2') { document.body.classList.add('flip-180'); } 
                else { document.body.classList.remove('flip-180'); }

                fetch('content.json')
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(config => {
                        if (config.mode === 'stretch') { showStretchMode(config.stretch_content, id); } 
                        else { showIndividualMode(config.individual_content['device-' + id], id); }
                    })
                    .catch(err => {
                        showError('Config Error', 'Could not load content.json. Check syntax.');
                        console.error(err);
                    });
            }

            function showSetupScreen() {
                const setupDiv = document.createElement('div');
                setupDiv.innerHTML = `<h1 style="color:white; text-align:center;">SETUP MODE</h1>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 80vh; padding: 20px;">
                        <button onclick="selectDevice('1')" style="font-size:3em; background:#4CAF50; color:white; border:none;">1 (Top-L)</button>
                        <button onclick="selectDevice('2')" style="font-size:3em; background:#2196F3; color:white; border:none;">2 (Top-R)</button>
                        <button onclick="selectDevice('3')" style="font-size:3em; background:#FF9800; color:white; border:none;">3 (Bot-L)</button>
                        <button onclick="selectDevice('4')" style="font-size:3em; background:#9C27B0; color:white; border:none;">4 (Bot-R)</button>
                    </div>`;
                window.selectDevice = function(id) { loadContent(id); };
                showWrapper('setup');
                allWrappers.setup.innerHTML = ''; 
                allWrappers.setup.appendChild(setupDiv);
            }

            function showStretchMode(content, id) {
                let element;
                if (content.type === 'google_slide') {
                    element = document.createElement('iframe'); element.src = content.url;
                } else if (content.type === 'video') {
                    element = document.createElement('video'); element.src = content.url; element.autoplay = true; element.muted = true; element.loop = true;
                }
                element.className = 'stretched-element'; 
                const offsets = { '1': 'translate(0, 0)', '2': 'translate(-50%, 0)', '3': 'translate(0, -50%)', '4': 'translate(-50%, -50%)' };
                if (element && offsets[id]) {
                    element.style.transform = offsets[id];
                    showWrapper('stretch');
                    allWrappers.stretch.innerHTML = ''; allWrappers.stretch.appendChild(element);
                }
            }

            function showIndividualMode(content, id) {
                if (!content) return showError('Config Error', `No content for Device ${id}`);
                if (content.type === 'google_slide') {
                    const iframe = document.createElement('iframe'); iframe.src = content.url;
                    allWrappers.slide.innerHTML = ''; allWrappers.slide.appendChild(iframe); showWrapper('slide');
                } else if (content.type === 'text') {
                    document.getElementById('text-headline').textContent = content.headline;
                    document.getElementById('text-body').textContent = content.body;
                    showWrapper('text');
                }
            }

            function showError(head, body) {
                document.getElementById('error-headline').textContent = head;
                document.getElementById('error-body').textContent = body;
                showWrapper('error');
            }

            function showWrapper(activeKey) {
                for (let key in allWrappers) {
                    if(allWrappers[key]) {
                        const displayType = (key === 'text' || key === 'error' || key === 'setup') ? 'flex' : 'block';
                        allWrappers[key].style.display = (key === activeKey) ? displayType : 'none';
                    }
                }
            }
        };
    </script>
</body>
</html>
