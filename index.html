<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>School Video Wall</title>

    <!-- PWA MANIFEST & SERVICE WORKER â€“ ABSOLUTE PATHS (REQUIRED) -->
    <link rel="manifest" href="/Video_Wall/manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/Video_Wall/sw.js');
        }
    </script>

    <style>
        *, *::before, *::after { box-sizing: border-box; }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: #000; overflow: hidden;
            cursor: none !important;               /* Permanent hidden cursor */
        }
        #stage { position: absolute; width: 100vw; height: 100vh; top: 0; left: 0; }
        #wall-display {
            position: absolute; display: block;
            transition: opacity 0.5s ease;
        }
        #clock-overlay {
            position: absolute; bottom: 30px; right: 30px;
            font-size: 4rem; font-weight: bold; color: rgba(255,255,255,0.9);
            text-shadow: 2px 2px 8px #000; z-index: 9999; pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="stage">
        <img id="wall-display" src="" alt="">
        <div id="clock-overlay">--:--</div>
    </div>

    <div style="display:none;">
        <img id="preload-individual" src="">
        <img id="preload-stretch" src="">
    </div>

    <script>
        // CONFIGURATION
        const STRETCH_START_TIME = 30;           // seconds when stretched mode begins
        const VERSION = '9';
        const BEZEL_H = 20;   // horizontal bezel compensation in pixels
        const BEZEL_V = 45;   // vertical bezel compensation in pixels

        // GET SCREEN ID
        const urlParams = new URLSearchParams(window.location.search);
        const screenId = urlParams.get('device') || urlParams.get('id') || '1';

        const img = document.getElementById('wall-display');
        const clock = document.getElementById('clock-overlay');
        if (screenId !== '4') clock.style.display = 'none';

        const individual = `screen${screenId}.jpg?v=${VERSION}`;
        const stretched  = `stretched.jpg?v=${VERSION}`;

        // Preload
        document.getElementById('preload-individual').src = individual;
        document.getElementById('preload-stretch').src = stretched;

        function updateDisplay() {
            const sec = new Date().getSeconds();

            // Clock (only screen 4)
            if (screenId === '4') {
                clock.innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            }

            if (sec < STRETCH_START_TIME) {
                // INDIVIDUAL MODE
                if (!img.src.includes(individual)) {
                    img.src = individual;
                    img.style.width = img.style.height = "100%";
                    img.style.top = img.style.left = "0";
                    img.style.objectFit = "contain";
                }
            } else {
                // STRETCHED MODE
                if (!img.src.includes(stretched)) {
                    img.src = stretched;
                    img.style.objectFit = "fill";
                    img.style.width  = `calc(200vw + ${BEZEL_H * 2}px)`;
                    img.style.height = `calc(200vh + ${BEZEL_V * 2}px)`;

                    switch(screenId) {
                        case '1': img.style.top = "0";               img.style.left = "0"; break;
                        case '2': img.style.top = "0";               img.style.left = `calc(-100vw - ${BEZEL_H}px)`; break;
                        case '3': img.style.top = `calc(-100vh - ${BEZEL_V}px)`; img.style.left = "0"; break;
                        case '4': img.style.top = `calc(-100vh - ${BEZEL_V}px)`; img.style.left = `calc(-100vw - ${BEZEL_H}px)`; break;
                    }
                }
            }
        }

        // Fullscreen + Wake Lock
        if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => {});
        if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(() => {});

        // Auto-update checks & forced refresh
        let lastModified = null;
        async function checkUpdates() {
            try {
                const r = await fetch(location.href.split('?')[0] + '?t=' + Date.now(), {method:'HEAD'});
                const m = r.headers.get('Last-Modified');
                if (lastModified && m && lastModified !== m) location.reload();
                if (m) lastModified = m;
            } catch(e) {}
        }
        setInterval(checkUpdates, 60000);
        setInterval(() => location.reload(), 7200000); // 2-hour hard refresh

        // Run
        setInterval(updateDisplay, 200);
        updateDisplay();
    </script>
</body>
</html>
