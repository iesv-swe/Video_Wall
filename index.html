<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Video Wall</title>
    <style>
        /* --- RESET & HIDE SCROLLBARS --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden; /* CRITICAL: Prevents white scrollbars */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* --- THE STAGE --- */
        #stage {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            overflow: hidden; 
        }

        /* --- THE IMAGE DISPLAY --- */
        #wall-display {
            position: absolute;
            display: block;
            transition: opacity 0.5s ease;
        }

        /* --- THE CLOCK OVERLAY --- */
        #clock-overlay {
            position: absolute;
            bottom: 30px;
            right: 30px;
            font-size: 4rem; 
            font-weight: bold;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 2px 2px 8px #000000;
            z-index: 9999; 
            pointer-events: none; 
        }
    </style>
</head>
<body>

    <div id="stage">
        <!-- Main Image Element -->
        <img id="wall-display" src="" alt="" onerror="this.style.display='none'">
        
        <!-- The Digital Clock -->
        <div id="clock-overlay">--:--</div>
    </div>

    <!-- PRELOADER -->
    <div style="display:none;">
        <img id="preload-individual" src="">
        <img id="preload-stretch" src=""> 
    </div>

    <script>
        // --- CONFIGURATION ---
        const STRETCH_START_TIME = 30; 
        const VERSION = '3'; 

        // --- ALIGNMENT SETTINGS ---
        const BEZEL_H = 20; 
        const BEZEL_V = 20; 

        // --- SETUP ---
        const urlParams = new URLSearchParams(window.location.search);
        const screenId = urlParams.get('device') || urlParams.get('id') || '1';
        
        const imgElement = document.getElementById('wall-display');
        const clockElement = document.getElementById('clock-overlay');

        // CLOCK VISIBILITY: Only show on Screen 4
        if (screenId !== '4') {
            clockElement.style.display = 'none';
        }
        
        const individualImage = 'screen' + screenId + '.jpg?v=' + VERSION;
        const stretchImage = 'stretched.jpg?v=' + VERSION; 
        
        document.getElementById('preload-individual').src = individualImage;
        document.getElementById('preload-stretch').src = stretchImage;

        // --- MAIN LOOP ---
        function updateDisplay() {
            const now = new Date();
            const currentSecond = now.getSeconds();

            // 1. UPDATE CLOCK (Only on Screen 4)
            if (screenId === '4') {
                const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                clockElement.innerText = timeString;
            }

            // 2. UPDATE IMAGES
            if (currentSecond < STRETCH_START_TIME) {
                if (!imgElement.src.includes(individualImage)) {
                    imgElement.style.display = 'block';
                    imgElement.src = individualImage;
                    imgElement.style.width = "100%";
                    imgElement.style.height = "100%";
                    imgElement.style.top = "0";
                    imgElement.style.left = "0";
                    imgElement.style.objectFit = "contain";
                }
            } else {
                if (!imgElement.src.includes(stretchImage)) {
                    imgElement.style.display = 'block';
                    imgElement.src = stretchImage;
                    imgElement.style.width = "calc(200vw + " + (BEZEL_H * 2) + "px)";
                    imgElement.style.height = "calc(200vh + " + (BEZEL_V * 2) + "px)";
                    imgElement.style.objectFit = "fill"; 
                    
                    switch (screenId) {
                        case '1': 
                            imgElement.style.top = "0";
                            imgElement.style.left = "0"; 
                            break;
                        case '2': 
                            imgElement.style.top = "0";
                            imgElement.style.left = "calc(-100vw - " + BEZEL_H + "px)";
                            break;
                        case '3': 
                            imgElement.style.top = "calc(-100vh - " + BEZEL_V + "px)";
                            imgElement.style.left = "0";
                            break;
                        case '4': 
                            imgElement.style.top = "calc(-100vh - " + BEZEL_V + "px)";
                            imgElement.style.left = "calc(-100vw - " + BEZEL_H + "px)";
                            break;
                    }
                }
            }
        }

        // --- WAKE LOCK & SHUTDOWN HANDLER (Fixes Rescue Bar) ---
        let wakeLock = null;

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock active');
                }
            } catch (err) { console.error('Wake Lock failed:', err); }
        }

        // Request on load
        requestWakeLock();

        // Re-request on visibility change
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') requestWakeLock();
        });

        // CLEAN RELEASE (This prevents the "Chromium didn't shut down correctly" bar)
        window.addEventListener('beforeunload', async () => {
            if (wakeLock) {
                await wakeLock.release();
                wakeLock = null;
            }
        });

        // EXPERIMENTAL: Attempt to hide infobar via JS (Hail Mary)
        setTimeout(() => {
            const infobar = document.querySelector('div[id*="infobar"]') || document.querySelector('#restore-pages');
            if (infobar) infobar.style.display = 'none';
        }, 1000);

        setInterval(updateDisplay, 200);
        updateDisplay();
    </script>
</body>
</html>
