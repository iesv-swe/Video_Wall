<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Video Wall</title>
    <style>
        /* --- RESET & HIDE SCROLLBARS --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #222; /* Dark Grey background to see if element loads */
            overflow: hidden; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* --- THE STAGE --- */
        #stage {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            overflow: hidden; 
        }

        /* --- THE IMAGE DISPLAY --- */
        #wall-display {
            position: absolute;
            display: block;
            transition: opacity 0.5s ease;
            background-color: #333; /* Placeholder color */
        }

        /* --- THE CLOCK OVERLAY --- */
        #clock-overlay {
            position: absolute;
            bottom: 30px;
            right: 30px;
            font-size: 4rem; 
            font-weight: bold;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 2px 2px 8px #000000;
            z-index: 9999; 
            pointer-events: none; 
        }

        /* --- DEBUG STATUS (Top Left) --- */
        #debug-status {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1rem;
            color: lime;
            font-family: monospace;
            z-index: 10000;
            background: rgba(0,0,0,0.5);
            padding: 5px;
        }
    </style>
</head>
<body>

    <div id="stage">
        <!-- Removed onerror hiding so we can see broken icons -->
        <img id="wall-display" src="" alt="Loading...">
        
        <!-- The Digital Clock -->
        <div id="clock-overlay">--:--</div>
        
        <!-- Debug Status -->
        <div id="debug-status">Initializing...</div>
    </div>

    <!-- PRELOADER -->
    <div style="display:none;">
        <img id="preload-individual" src="">
        <img id="preload-stretch" src=""> 
    </div>

    <script>
        // --- CONFIGURATION ---
        const STRETCH_START_TIME = 30; 
        const VERSION = '4'; // Bumped version
        
        // SESSION ID: Random number generated on every boot. 
        // This forces a fresh download of images every time the device turns on.
        const SESSION_ID = Math.floor(Math.random() * 10000);

        // --- ALIGNMENT SETTINGS ---
        const BEZEL_H = 20; 
        const BEZEL_V = 20; 

        // --- SETUP ---
        const urlParams = new URLSearchParams(window.location.search);
        const screenId = urlParams.get('device') || urlParams.get('id') || '1';
        
        const imgElement = document.getElementById('wall-display');
        const clockElement = document.getElementById('clock-overlay');
        const debugElement = document.getElementById('debug-status');

        // CLOCK VISIBILITY: Only show on Screen 4
        if (screenId !== '4') {
            clockElement.style.display = 'none';
        }
        
        // CONSTRUCT URLs with Session Buster
        const individualImage = 'screen' + screenId + '.jpg?v=' + VERSION + '&s=' + SESSION_ID;
        const stretchImage = 'stretched.jpg?v=' + VERSION + '&s=' + SESSION_ID; 
        
        document.getElementById('preload-individual').src = individualImage;
        document.getElementById('preload-stretch').src = stretchImage;

        // --- MAIN LOOP ---
        function updateDisplay() {
            const now = new Date();
            const currentSecond = now.getSeconds();

            // 1. UPDATE CLOCK (Only on Screen 4)
            if (screenId === '4') {
                const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                clockElement.innerText = timeString;
            }

            // 2. UPDATE IMAGES
            if (currentSecond < STRETCH_START_TIME) {
                // --- INDIVIDUAL MODE ---
                if (!imgElement.src.includes(individualImage)) {
                    debugElement.innerText = `[INDIVIDUAL] ${individualImage}`; // Debug Info
                    imgElement.src = individualImage;
                    
                    imgElement.style.width = "100%";
                    imgElement.style.height = "100%";
                    imgElement.style.top = "0";
                    imgElement.style.left = "0";
                    imgElement.style.objectFit = "contain";
                }
            } else {
                // --- STRETCH MODE ---
                if (!imgElement.src.includes(stretchImage)) {
                    debugElement.innerText = `[STRETCH] ${stretchImage}`; // Debug Info
                    imgElement.src = stretchImage;
                    
                    imgElement.style.width = "calc(200vw + " + (BEZEL_H * 2) + "px)";
                    imgElement.style.height = "calc(200vh + " + (BEZEL_V * 2) + "px)";
                    imgElement.style.objectFit = "fill"; 
                    
                    switch (screenId) {
                        case '1': 
                            imgElement.style.top = "0";
                            imgElement.style.left = "0"; 
                            break;
                        case '2': 
                            imgElement.style.top = "0";
                            imgElement.style.left = "calc(-100vw - " + BEZEL_H + "px)";
                            break;
                        case '3': 
                            imgElement.style.top = "calc(-100vh - " + BEZEL_V + "px)";
                            imgElement.style.left = "0";
                            break;
                        case '4': 
                            imgElement.style.top = "calc(-100vh - " + BEZEL_V + "px)";
                            imgElement.style.left = "calc(-100vw - " + BEZEL_H + "px)";
                            break;
                    }
                }
            }
        }

        // --- WAKE LOCK ---
        let wakeLock = null;
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) { console.error(err); }
        }
        requestWakeLock();
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') requestWakeLock();
        });
        window.addEventListener('beforeunload', async () => {
            if (wakeLock) { await wakeLock.release(); wakeLock = null; }
        });

        // Hide Rescue Bar Attempt
        setTimeout(() => {
            const infobar = document.querySelector('div[id*="infobar"]') || document.querySelector('#restore-pages');
            if (infobar) infobar.style.display = 'none';
        }, 1000);

        setInterval(updateDisplay, 200);
        updateDisplay();
    </script>
</body>
</html>
